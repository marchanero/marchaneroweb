---
// Componente para mostrar m칠tricas bibliom칠tricas actualizadas
import scholarData from '../data/scholar.json';

interface Props {
  showDetails?: boolean;
  compact?: boolean;
}

const { showDetails = false, compact = false } = Astro.props;

// Funci칩n para formatear n칰meros grandes
function formatNumber(num: number): string {
  if (num >= 1000) {
    return (num / 1000).toFixed(1) + 'k';
  }
  return num.toString();
}

// Calcular m칠tricas usando los datos disponibles
const years = scholarData.publications
  .map(pub => pub.year)
  .filter(year => year && !isNaN(year))
  .map(year => parseInt(year));

const minYear = Math.min(...years);
const maxYear = Math.max(...years);
const careerSpan = maxYear - minYear + 1;

const avgPublicationsPerYear = Math.round(scholarData.publications.length / careerSpan) || 0;
const avgCitationsPerPaper = Math.round(scholarData.metrics.totalCitations / scholarData.publications.length) || 0;

// Calcular publicaciones por a침o
const publicationsByYear: Record<string, number> = {};
scholarData.publications.forEach(pub => {
  if (pub.year) {
    const year = pub.year.toString();
    publicationsByYear[year] = (publicationsByYear[year] || 0) + 1;
  }
});

// Preparar datos para la gr치fica de progreso
const yearRange = Array.from({length: careerSpan}, (_, i) => minYear + i);
const yearData = yearRange.map(year => ({
  year,
  publications: publicationsByYear[year.toString()] || 0
}));

const maxPublications = Math.max(...Object.values(publicationsByYear));
const peakPublicationYear = Object.keys(publicationsByYear).find(year => 
  publicationsByYear[year] === maxPublications
);

// Calcular citas acumuladas por a침o aproximadamente
const citationsByYear: Record<string, number> = {};
scholarData.publications.forEach(pub => {
  if (pub.year && pub.cited_by?.value) {
    const year = pub.year.toString();
    citationsByYear[year] = (citationsByYear[year] || 0) + pub.cited_by.value;
  }
});

const citationData = yearRange.map(year => ({
  year,
  citations: citationsByYear[year.toString()] || 0
}));

const maxCitations = Math.max(...Object.values(citationsByYear), 1);
---

<div class={`${compact ? 'p-4' : 'p-6'} bg-white dark:bg-gray-800 rounded-xl shadow-lg`}>
  <h3 class={`${compact ? 'text-lg' : 'text-xl'} font-bold text-gray-900 dark:text-white mb-4 flex items-center`}>
    游늵 M칠tricas Bibliom칠tricas
    <span class="ml-2 text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded-full">
      Actualizado
    </span>
  </h3>
  
  <!-- M칠tricas principales -->
  <div class={`grid ${compact ? 'grid-cols-2 gap-3' : 'grid-cols-1 md:grid-cols-3 gap-4'} mb-4`}>
    <div class="text-center">
      <div class={`${compact ? 'text-2xl' : 'text-3xl'} font-bold text-blue-600 dark:text-blue-400`}>
        {formatNumber(scholarData.metrics.totalCitations)}
      </div>
      <div class="text-sm text-gray-600 dark:text-gray-400">Citas Totales</div>
      {showDetails && (
        <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">
          {scholarData.metrics.citationsRecent} 칰ltimos 5 a침os
        </div>
      )}
    </div>
    
    <div class="text-center">
      <div class={`${compact ? 'text-2xl' : 'text-3xl'} font-bold text-green-600 dark:text-green-400`}>
        {scholarData.metrics.hIndex}
      </div>
      <div class="text-sm text-gray-600 dark:text-gray-400">칈ndice h</div>
      {showDetails && (
        <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">
          {scholarData.metrics.hIndexRecent} 칰ltimos 5 a침os
        </div>
      )}
    </div>
    
    <div class="text-center">
      <div class={`${compact ? 'text-2xl' : 'text-3xl'} font-bold text-purple-600 dark:text-purple-400`}>
        {scholarData.metrics.i10Index}
      </div>
      <div class="text-sm text-gray-600 dark:text-gray-400">칈ndice i10</div>
      {showDetails && (
        <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">
          {scholarData.metrics.i10IndexRecent} 칰ltimos 5 a침os
        </div>
      )}
    </div>
    
    {!compact && (
      <>
        <div class="text-center">
          <div class="text-3xl font-bold text-orange-600 dark:text-orange-400">
            {scholarData.publications.length}
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Publicaciones</div>
        </div>
        
        <div class="text-center">
          <div class="text-3xl font-bold text-red-600 dark:text-red-400">
            {avgCitationsPerPaper}
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Citas/Art칤culo</div>
        </div>
        
        <div class="text-center">
          <div class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">
            {avgPublicationsPerYear}
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Art칤culos/A침o</div>
        </div>
      </>
    )}
  </div>
  
  {showDetails && (
    <div class="border-t dark:border-gray-700 pt-4">
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div>
          <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Actividad</h4>
          <ul class="space-y-1 text-gray-600 dark:text-gray-400">
            <li>Carrera activa: {careerSpan} a침os ({minYear}-{maxYear})</li>
            <li>A침os con publicaciones: {Object.keys(publicationsByYear).length}</li>
            <li>Pico de publicaciones: {maxPublications} ({peakPublicationYear})</li>
          </ul>
        </div>
        <div>
          <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Productividad</h4>
          <ul class="space-y-1 text-gray-600 dark:text-gray-400">
            <li>Promedio: {avgPublicationsPerYear} pub/a침o</li>
            <li>Impacto: {avgCitationsPerPaper} citas/art칤culo</li>
            <li>Rango a침os: {minYear} - {maxYear}</li>
          </ul>
        </div>
      </div>
    </div>
  )}
  
  <!-- Gr치fica de progreso por a침os -->
  {!compact && (
    <div class="mt-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
      <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
        游늳 Evoluci칩n Temporal
        <span class="ml-2 text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-full">
          {minYear} - {maxYear}
        </span>
      </h4>
      
      <!-- Gr치fica de barras de publicaciones -->
      <div class="mb-6">
        <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
          游닄 Publicaciones por A침o
        </h5>
        <div class="flex items-end space-x-1 h-24 bg-white dark:bg-gray-800 rounded p-2">
          {yearData.map(({ year, publications }) => {
            const height = maxPublications > 0 ? (publications / maxPublications) * 100 : 0;
            return (
              <div class="flex-1 flex flex-col items-center">
                <div 
                  class="w-full bg-blue-500 hover:bg-blue-600 transition-colors duration-200 rounded-t"
                  style={`height: ${height}%; min-height: ${publications > 0 ? '8px' : '2px'}`}
                  title={`${year}: ${publications} publicaciones`}
                >
                </div>
                <span class="text-xs text-gray-600 dark:text-gray-400 mt-1 transform -rotate-45">
                  {year}
                </span>
              </div>
            );
          })}
        </div>
        <div class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-center">
          M치ximo: {maxPublications} publicaciones en {peakPublicationYear}
        </div>
      </div>
      
      <!-- Gr치fica de citas por a침o -->
      <div>
        <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
          游늵 Citas por A침o de Publicaci칩n
        </h5>
        <div class="flex items-end space-x-1 h-24 bg-white dark:bg-gray-800 rounded p-2">
          {citationData.map(({ year, citations }) => {
            const height = maxCitations > 0 ? (citations / maxCitations) * 100 : 0;
            return (
              <div class="flex-1 flex flex-col items-center">
                <div 
                  class="w-full bg-green-500 hover:bg-green-600 transition-colors duration-200 rounded-t"
                  style={`height: ${height}%; min-height: ${citations > 0 ? '8px' : '2px'}`}
                  title={`${year}: ${citations} citas`}
                >
                </div>
                <span class="text-xs text-gray-600 dark:text-gray-400 mt-1 transform -rotate-45">
                  {year}
                </span>
              </div>
            );
          })}
        </div>
        <div class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-center">
          Total citas: {scholarData.metrics.totalCitations} | Promedio: {avgCitationsPerPaper} por art칤culo
        </div>
      </div>
    </div>
  )}
  
  {showDetails && (
    <div class="border-t dark:border-gray-700 pt-4">
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div>
          <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Actividad</h4>
          <ul class="space-y-1 text-gray-600 dark:text-gray-400">
            <li>Carrera activa: {careerSpan} a침os ({minYear}-{maxYear})</li>
            <li>A침os con publicaciones: {Object.keys(publicationsByYear).length}</li>
            <li>Pico de publicaciones: {maxPublications} ({peakPublicationYear})</li>
          </ul>
        </div>
        <div>
          <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Productividad</h4>
          <ul class="space-y-1 text-gray-600 dark:text-gray-400">
            <li>Promedio: {avgPublicationsPerYear} pub/a침o</li>
            <li>Impacto: {avgCitationsPerPaper} citas/art칤culo</li>
            <li>Rango a침os: {minYear} - {maxYear}</li>
          </ul>
        </div>
      </div>
    </div>
  )}
  
  <div class="mt-4 text-xs text-gray-500 dark:text-gray-400 text-center">
    칔ltima actualizaci칩n: {new Date(scholarData.lastUpdated).toLocaleDateString('es-ES', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    })}
  </div>
</div>
