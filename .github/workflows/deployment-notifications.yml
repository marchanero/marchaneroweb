name: Deployment Notifications

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        
      # Notificaci√≥n por Telegram
      - name: Notificar por Telegram
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            üöÄ *Sitio web desplegado correctamente*
            
            *Dr. Roberto S√°nchez Reolid - UCLM*
            
            üìù Commit: ${{ github.event.workflow_run.head_commit.message }}
            üë®‚Äçüíª Autor: ${{ github.event.workflow_run.head_commit.author.name }}
            üïí Fecha: ${{ github.event.workflow_run.updated_at }}
            
            üåê Ver sitio: https://roberto-sreolid.netlify.app
            
            üìä *Estado de validaciones*
            ‚úÖ Tests: Aprobados
            ‚úÖ Validaci√≥n web: Aprobada
            ‚úÖ Estructura de contenido: Correcta
            
            _Universidad de Castilla-La Mancha_
          format: markdown
          disable_web_page_preview: true
      
      # Notificaci√≥n por correo electr√≥nico
      - name: Enviar notificaci√≥n por correo
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: Actualizaci√≥n del sitio web - Dr. Roberto S√°nchez Reolid
          body: |
            ¬°Se ha realizado un nuevo despliegue del sitio web!
            
            Commit: ${{ github.event.workflow_run.head_commit.message }}
            Autor: ${{ github.event.workflow_run.head_commit.author.name }}
            Fecha: ${{ github.event.workflow_run.updated_at }}
            
            Ver sitio: https://roberto-sreolid.netlify.app
            
            Todos los tests han pasado correctamente.
            
            Este es un mensaje autom√°tico del sistema de CI/CD de la UCLM.
          to: roberto.sreolid@uclm.es, webmaster@uclm.es
          cc: grupo.investigacion@uclm.es
          from: Despliegue Web UCLM <noreply@uclm.es>
          attachments: |
            CHANGELOG.md
            README.md
          
      # Crear una issue en GitHub si se necesita revisi√≥n post-despliegue
      - name: Crear issue para revisi√≥n post-despliegue
        if: ${{ github.event.workflow_run.head_branch == 'main' }}
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: Revisi√≥n del sitio web - ${{ github.event.workflow_run.head_commit.message }}
          content: |
            ## Revisi√≥n Post-Despliegue del Sitio Web

            Se ha realizado un nuevo despliegue del sitio web del Dr. Roberto S√°nchez Reolid.
            
            ### Detalles:
            
            - **Commit**: ${{ github.event.workflow_run.head_commit.message }}
            - **Autor**: ${{ github.event.workflow_run.head_commit.author.name }}
            - **URL**: https://roberto-sreolid.netlify.app
            - **Fecha de despliegue**: ${{ github.event.workflow_run.updated_at }}
            
            ### Checklist de revisi√≥n:
            
            - [ ] Verificar que todas las p√°ginas se cargan correctamente
            - [ ] Verificar la informaci√≥n de contacto 
            - [ ] Revisar la visualizaci√≥n en dispositivos m√≥viles
            - [ ] Comprobar los metadatos y SEO
            - [ ] Verificar que las referencias son correctas
            - [ ] Comprobar que el formulario de contacto funciona
            - [ ] Verificar que los enlaces externos funcionan correctamente
            - [ ] Revisar que no hay errores en la consola del navegador
            
            ### Indicadores de rendimiento:
            
            - [ ] Tiempo de carga < 2s
            - [ ] Score de Lighthouse > 90 en Performance
            - [ ] Score de Lighthouse > 95 en Accesibilidad
            - [ ] Score de Lighthouse > 95 en SEO
            
            Una vez completada la revisi√≥n, a√±ade tus comentarios y cierra esta issue.
          labels: revisi√≥n, web, despliegue, UCLM
          assignees: webmaster, roberto-sreolid
