name: Deploy to Netlify

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]
  # Permite ejecutar manualmente desde la pesta√±a Actions
  workflow_dispatch:

jobs:
  # FASE 1: VALIDACI√ìN Y CONSTRUCCI√ìN
  # =================================
  
  # Paso 1: Validaci√≥n inicial del c√≥digo
  validate:
    name: Validaci√≥n y Lint
    runs-on: ubuntu-latest
    # No ejecutar en PRs marcados como draft
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci
      
      - name: Cargar variables de entorno
        run: |
          if [ -f "./scripts/load-env-vars.js" ]; then
            node ./scripts/load-env-vars.js
          else
            echo "Script de carga de variables no encontrado, continuando..."
          fi
        
      - name: Verificar configuraci√≥n de Telegram
        run: |
          if [ -f "./scripts/verify-telegram-config.js" ]; then
            node ./scripts/verify-telegram-config.js || true
          else
            echo "Script de verificaci√≥n de Telegram no encontrado, continuando..."
          fi
        
      - name: Verificaci√≥n previa al despliegue
        run: |
          if [ -f "./scripts/pre-deploy-check.js" ]; then
            node ./scripts/pre-deploy-check.js
          else
            echo "Script de verificaci√≥n previa no encontrado, continuando..."
          fi

      - name: Build inicial para validaci√≥n
        run: npm run build
        
  # Paso 2: Ejecuci√≥n de tests
  test:
    name: Ejecutar Tests
    needs: validate
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Ejecutar tests completos
        run: |
          # Verificar qu√© scripts de test est√°n disponibles
          if npm run test:build > /dev/null 2>&1; then
            npm run test:build
          elif npm run test:all-fixed > /dev/null 2>&1; then
            npm run test:all-fixed
          else
            npm test
          fi
        
      - name: Ejecutar tests espec√≠ficos
        run: |
          # Ejecutar tests espec√≠ficos si est√°n disponibles
          if npm run test:pages > /dev/null 2>&1; then
            npm run test:pages
          fi
          if npm run test:seo > /dev/null 2>&1; then
            npm run test:seo
          fi
        
      - name: Guardar resultados de tests
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            junit.xml
            coverage/
          retention-days: 7
          
  # FASE 2: BUILD Y OPTIMIZACI√ìN
  # ============================
  
  # Paso 3: Build optimizado para producci√≥n
  build:
    name: Build para Producci√≥n
    needs: test
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci
        
      - name: Cargar variables de entorno
        run: |
          if [ -f "./scripts/load-env-vars.js" ]; then
            node ./scripts/load-env-vars.js
          fi
        
      - name: Build para producci√≥n
        run: npm run build
        
      - name: Generar sitemap.xml
        run: |
          if [ ! -f "./dist/sitemap.xml" ]; then
            echo '<?xml version="1.0" encoding="UTF-8"?>' > ./dist/sitemap.xml
            echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.sitemaps.org/schemas/sitemap/0.9 http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd">' >> ./dist/sitemap.xml
            
            # P√°gina principal
            echo '  <url>' >> ./dist/sitemap.xml
            echo '    <loc>https://roberto-sreolid.netlify.app/</loc>' >> ./dist/sitemap.xml
            echo '    <lastmod>'$(date +%Y-%m-%d)'</lastmod>' >> ./dist/sitemap.xml
            echo '    <priority>1.00</priority>' >> ./dist/sitemap.xml
            echo '  </url>' >> ./dist/sitemap.xml
            
            # Otras p√°ginas
            for page in sobre-mi proyectos contacto asignaturas; do
              if [ -f "./src/pages/${page}.astro" ]; then
                echo '  <url>' >> ./dist/sitemap.xml
                echo '    <loc>https://roberto-sreolid.netlify.app/'$page'/</loc>' >> ./dist/sitemap.xml
                echo '    <lastmod>'$(date +%Y-%m-%d)'</lastmod>' >> ./dist/sitemap.xml
                echo '    <priority>0.80</priority>' >> ./dist/sitemap.xml
                echo '  </url>' >> ./dist/sitemap.xml
              fi
            done
            
            echo '</urlset>' >> ./dist/sitemap.xml
            echo "‚úÖ Sitemap generado en ./dist/sitemap.xml"
          else
            echo "‚úÖ Sitemap ya existe"
          fi
          
      - name: Generar robots.txt
        run: |
          if [ ! -f "./dist/robots.txt" ]; then
            echo "User-agent: *" > ./dist/robots.txt
            echo "Allow: /" >> ./dist/robots.txt
            echo "Sitemap: https://roberto-sreolid.netlify.app/sitemap.xml" >> ./dist/robots.txt
            echo "‚úÖ Robots.txt generado en ./dist/robots.txt"
          else
            echo "‚úÖ Robots.txt ya existe"
          fi
        
      - name: Optimizar assets
        run: |
          # Instalar herramientas de optimizaci√≥n si est√°n disponibles
          if command -v npx >/dev/null 2>&1; then
            # Intentar optimizar HTML si html-minifier-terser est√° disponible
            if npm list html-minifier-terser >/dev/null 2>&1 || npm install --no-save html-minifier-terser; then
              find ./dist -type f -name "*.html" -exec npx html-minifier-terser --collapse-whitespace --remove-comments --remove-optional-tags --remove-redundant-attributes --remove-script-type-attributes --remove-tag-whitespace --use-short-doctype -o {} {} \; 2>/dev/null || echo "HTML minification skipped"
            fi
            
            # Comprimir archivos para mejor rendimiento
            find ./dist -type f -name "*.js" -exec gzip -9 -k {} \; 2>/dev/null || echo "JS compression skipped"
            find ./dist -type f -name "*.css" -exec gzip -9 -k {} \; 2>/dev/null || echo "CSS compression skipped"
            find ./dist -type f -name "*.html" -exec gzip -9 -k {} \; 2>/dev/null || echo "HTML compression skipped"
          fi
          
          echo "‚úÖ Optimizaci√≥n de assets completada"
      
      - name: Subir artefacto de build
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: ./dist
          retention-days: 1
          
  # FASE 3: CONTROL DE CALIDAD (Solo en push a main)
  # ================================================
  
  # Paso 4: Validaci√≥n de accesibilidad (opcional)
  accessibility:
    name: Validaci√≥n de Accesibilidad
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && success()

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Descargar build
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: dist

      - name: Ejecutar pruebas de accesibilidad
        run: |
          if npm run test:a11y > /dev/null 2>&1; then
            npm run test:a11y || echo "Pruebas de accesibilidad fallaron, pero no bloquean el despliegue"
          else
            echo "Script de accesibilidad no disponible, continuando..."
          fi
          
      - name: Guardar reporte de accesibilidad
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-reports
          path: |
            accessibility-report.md
            .pa11yci-results.json
          retention-days: 7
  
  # FASE 4: DESPLIEGUES
  # ===================
  
  # Paso 5a: Deploy de vista previa (solo en PRs)
  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request' && success()
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Descargar artefacto de build
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: ./dist
      
      - name: Deploy Preview a Netlify
        uses: nwtgck/actions-netlify@v3
        with:
          publish-dir: './dist'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Vista previa desde PR #${{ github.event.number }}"
          enable-pull-request-comment: true
          enable-commit-comment: false
          overwrites-pull-request-comment: true
          alias: preview-web-${{ github.event.number }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        timeout-minutes: 5
        
      - name: Comentario con resumen (PR)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## üöÄ Vista previa desplegada ‚úÖ
                
                La vista previa del sitio web est√° lista para su revisi√≥n.
                
                ### Proceso completado secuencialmente:
                1. ‚úÖ Validaci√≥n y lint
                2. ‚úÖ Tests ejecutados correctamente
                3. ‚úÖ Build optimizado para producci√≥n
                4. ‚úÖ Preview desplegado en Netlify
                
                ### Enlaces √∫tiles:
                - üåê **Vista previa**: https://preview-web-${{ github.event.number }}--roberto-sreolid.netlify.app
                - üìä **Detalles del workflow**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
                
                ### Checklist de revisi√≥n:
                - [ ] Verificar que todas las p√°ginas se cargan correctamente
                - [ ] Revisar la informaci√≥n acad√©mica y de contacto
                - [ ] Comprobar la visualizaci√≥n en dispositivos m√≥viles
                - [ ] Verificar que los enlaces funcionan correctamente
                
                **Dr. Roberto S√°nchez Reolid - Universidad de Castilla-La Mancha**`
              });
            } catch (error) {
              console.error(\`Error en el comentario: \${error.message}\`);
            }

  # Paso 5b: Deploy a producci√≥n (solo en main)
  deploy-production:
    name: Deploy a Producci√≥n
    runs-on: ubuntu-latest
    needs: [build, accessibility]
    # Solo ejecutamos el despliegue en rama principal
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && (success() || needs.accessibility.result == 'skipped')
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci
        
      - name: Cargar variables de entorno
        run: |
          if [ -f "./scripts/load-env-vars.js" ]; then
            node ./scripts/load-env-vars.js
          fi
        
      - name: Importar variables de entorno a Netlify
        run: |
          if [ -f "./scripts/import-env-to-netlify.js" ]; then
            node ./scripts/import-env-to-netlify.js || echo "Import de variables fall√≥, continuando..."
          fi

      - name: Descargar artefacto de build
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: ./dist

      - name: Deploy a Netlify
        uses: nwtgck/actions-netlify@v3
        with:
          publish-dir: './dist'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy desde GitHub Actions - ${{ github.event.head_commit.message }}"
          enable-pull-request-comment: false
          enable-commit-comment: true
          overwrites-pull-request-comment: false
          functions-dir: './netlify/functions'
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        timeout-minutes: 5
  
  # FASE 5: NOTIFICACIONES
  # ======================
  
  # Paso 6: Notificar resultados
  notify:
    name: Notificar Resultados
    runs-on: ubuntu-latest
    needs: [deploy-production, deploy-preview]
    if: always() && (needs.deploy-production.result != 'skipped' || needs.deploy-preview.result != 'skipped')
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        
      - name: Configurar Node.js para scripts
        uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: Instalar dependencias
        run: npm ci
        
      - name: Cargar variables de entorno
        run: |
          if [ -f "./scripts/load-env-vars.js" ]; then
            node ./scripts/load-env-vars.js
          fi
      
      # Notificaci√≥n para despliegue exitoso a producci√≥n
      - name: Notificar por Telegram (Deploy Producci√≥n)
        if: needs.deploy-production.result == 'success'
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            üöÄ *Sitio web desplegado correctamente*
            
            *Dr. Roberto S√°nchez Reolid - UCLM*
            
            üìù Commit: ${{ github.event.head_commit.message }}
            üë®‚Äçüíª Autor: ${{ github.event.head_commit.author.name }}
            üïí Fecha: ${{ github.event.head_commit.timestamp }}
            
            üåê Ver sitio: https://roberto-sreolid.netlify.app
            
            üìä *Estado de validaciones*
            ‚úÖ Tests: Aprobados
            ‚úÖ Build: Completado
            ‚úÖ Deploy: Exitoso
            
            _Universidad de Castilla-La Mancha_
          format: markdown
          disable_web_page_preview: true
          
      # Notificaci√≥n para vista previa
      - name: Notificar por Telegram (Preview)
        if: needs.deploy-preview.result == 'success'
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            üîç *Vista previa generada*
            
            *Dr. Roberto S√°nchez Reolid - UCLM*
            
            üìå PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}
            üë®‚Äçüíª Autor: ${{ github.event.pull_request.user.login }}
            
            üåê Ver vista previa: https://preview-web-${{ github.event.pull_request.number }}--roberto-sreolid.netlify.app
            
            _Universidad de Castilla-La Mancha_
          format: markdown
          disable_web_page_preview: true
      
      # Notificaci√≥n para fallos
      - name: Notificar fallos por Telegram
        if: failure() || needs.deploy-preview.result == 'failure' || needs.deploy-production.result == 'failure'
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ‚ùå *Error en el despliegue*
            
            *Dr. Roberto S√°nchez Reolid - UCLM*
            
            ${{ github.event_name == 'pull_request' && format('üìå PR #{0}: {1}', github.event.pull_request.number, github.event.pull_request.title) || format('üìù Commit: {0}', github.event.head_commit.message) }}
            
            ‚ö†Ô∏è Ver detalles del error en GitHub Actions:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            _Universidad de Castilla-La Mancha_
          format: markdown
          disable_web_page_preview: true
      
      # Notificaci√≥n por correo electr√≥nico (solo para producci√≥n exitosa)
      - name: Enviar notificaci√≥n por correo
        if: needs.deploy-production.result == 'success' && secrets.MAIL_SERVER != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: Actualizaci√≥n del sitio web - Dr. Roberto S√°nchez Reolid
          body: |
            ¬°Se ha realizado un nuevo despliegue del sitio web!
            
            Commit: ${{ github.event.head_commit.message }}
            Autor: ${{ github.event.head_commit.author.name }}
            Fecha: ${{ github.event.head_commit.timestamp }}
            
            Ver sitio: https://roberto-sreolid.netlify.app
            
            Todos los tests han pasado correctamente.
            
            Este es un mensaje autom√°tico del sistema de CI/CD.
            Universidad de Castilla-La Mancha
          to: roberto.sreolid@uclm.es
          from: Despliegue Web UCLM <noreply@uclm.es>
